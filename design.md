# 王小明智能体设计文档

## 1. 系统概述

### 1.1 核心说明
王小明是一个基于 DeepSeek Chat API 的对话系统。他的人设是一个25岁的年轻人，性格热情、好奇、犀利而幽默，喜欢科技、音乐、电影和美食。他用年轻人的方式与人交流，善于使用流行语和生动的比喻。通过记忆系统的支持，他能够记住与用户的交互，形成持续的对话体验。

### 1.2 系统架构
- 前端：HTML + JavaScript（原生实现）
- 后端：Python + Flask
- AI模型：DeepSeek API
- 数据存储：SQLite
- 环境管理：Python虚拟环境
- 配置管理：JSON配置文件
- 记忆管理：Web可视化界面

## 2. 技术实现

### 2.1 目录结构
```
wangxiaoming/
├── .env                 # 环境变量配置文件（包含API密钥）
├── config/             
│   ├── persona.json    # 人设配置文件
│   └── memory_rules.json # 记忆系统规则配置
├── static/             
│   ├── css/            # 样式文件
│   │   ├── style.css   # 主样式文件
│   │   └── memories.css # 记忆管理页面样式
│   └── js/             # JavaScript文件
│       ├── main.js     # 主交互逻辑
│       └── memories.js  # 记忆管理页面逻辑
├── templates/
│   ├── index.html      # 主页面模板
│   └── memories.html   # 记忆管理页面模板
├── app.py              # Flask应用主文件
├── memory_system.py    # 记忆系统核心模块
├── requirements.txt     # 项目依赖
├── README.md           # 项目说明
└── design.md           # 设计文档
```

### 2.2 组件说明

#### 2.2.1 记忆系统 (memory_system.py)
- **核心功能**
  - 记忆提取：基于触发词自动从对话中提取记忆
  - 记忆存储：使用SQLite数据库持久化存储记忆
  - 记忆检索：根据相关性和时效性检索记忆
  - 对话历史：维护完整的对话上下文

- **记忆类型**
  - 个人信息：用户的基本信息（保留30天）
  - 偏好习惯：用户的喜好和习惯（保留30天）
  - 对话上下文：重要的对话内容（保留7天）
  - 情感状态：用户的情绪状态（保留1天）

- **数据结构**
  - memories表：存储提取的记忆
  - conversations表：存储对话历史

#### 2.2.2 记忆规则配置 (memory_rules.json)
- 记忆类型定义
- 触发词配置
- 提取规则设置
- 记忆优先级管理

#### 2.2.3 后端实现 (app.py)
- Flask Web框架
- 用户会话管理
- DeepSeek API集成
- 记忆系统集成
  - 自动记忆提取
  - 动态系统提示生成
  - 对话历史管理
- 记忆管理API
  - 记忆数据查询接口
  - 记忆使用记录接口

#### 2.2.4 前端实现
- **聊天界面**
  - HTML (index.html)
    - 响应式布局
    - 简洁的聊天界面
    - 消息输入区域
  
  - CSS (style.css)
    - 现代化UI设计
    - 响应式布局支持
    - 消息气泡样式
    - 交互状态样式

  - JavaScript (main.js)
    - 异步消息发送
    - 实时消息显示
    - 错误处理
    - 用户体验优化

- **记忆管理界面**
  - HTML (memories.html)
    - 记忆卡片网格布局
    - 记忆使用记录列表
    - 导航栏
  
  - CSS (memories.css)
    - 卡片式布局
    - 响应式网格设计
    - 优雅的动画效果
    - 清晰的信息层级

  - JavaScript (memories.js)
    - 异步数据加载
    - 动态内容渲染
    - 自动数据刷新
    - 日期格式化

### 2.3 依赖要求
- Python 3.11（必需，因为一些关键依赖包如pydantic目前还不完全支持Python 3.13）
- Flask==3.0.2
- python-dotenv==1.0.1
- requests==2.31.0
- uuid==1.30

## 3. 记忆系统工作流程

### 3.1 记忆提取流程
1. 用户发送消息
2. 系统根据触发词分析消息内容
3. 提取符合规则的记忆点
4. 为记忆分配类型和优先级
5. 存储到数据库

### 3.2 记忆应用流程
1. 收到用户消息时
2. 检索相关记忆
3. 组合记忆和人设提示
4. 生成完整的系统提示
5. 调用AI生成回复

### 3.3 记忆管理
- 自动过期机制
- 优先级排序
- 上下文关联
- 记忆检索优化
- Web可视化管理
  - 记忆内容查看
  - 记忆使用追踪
  - 实时数据更新
  - 分类展示

## 4. 安全性考虑
1. 所有敏感信息通过环境变量管理
2. 用户数据安全存储
3. 会话管理安全
4. 输入验证和清理
5. 记忆访问控制

## 5. 注意事项
- 请勿将包含敏感信息的.env文件提交到版本控制系统
- 可以根据需要修改persona.json来调整王小明的人设
- 可以通过memory_rules.json调整记忆系统的行为
- 定期维护数据库，清理过期记忆
- 在生产环境部署时，请确保使用安全的HTTPS连接
